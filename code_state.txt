Current focus:
- Resolve Supabase Storage signed upload failures (JWS Protected Header invalid) and verify env keys.
- Confirm magic-link login flow works with client-side auth callback.

What's working:
- Auth bypass flag removed; login required again.
- /auth/callback handled client-side with Suspense, allowing Supabase session detection in browser.
- Signed upload debug response available at /api/uploads/signed?debug=1 to validate key shape.
- Local builds can suppress PWA generation using DISABLE_PWA=true.

What's broken:
- /api/uploads/signed still returns JWS Protected Header invalid in Vercel logs.

Latest files touched:
- middleware.ts
- app/api/uploads/signed/route.ts
- app/auth/callback/page.tsx
- next.config.js
- .env.local (local only)
- NOTES.md
- code_state.txt

Commands to run locally:
- DISABLE_PWA=true npm run build

Last successful end-to-end test:
- None since auth callback change; needs re-test.

Next 3 concrete steps:
1) Redeploy and call /api/uploads/signed?debug=1 to confirm key prefix/dot count and project host.
2) Re-test magic link flow end-to-end (no extra login prompt).
3) Re-test photo upload flow after verifying service role key.
