# Project Notes & Timeline

Use this file to capture decisions, changes, and open questions after each working session. Append new session entries; do not rewrite past entries.

## Session Entry Template
- Date/Time (YYYY-MM-DD HH:MM), Session Goal:
- What changed:
  - 
- Decisions made:
  - 
- Open questions / risks:
  - 
- Next actions:
  - [ ] 

## Session Timeline
- Date/Time (2026-01-07 08:32), Session Goal: Initialize project memory system
  - What changed:
    - Added NOTES.md, ARCHITECTURE.md, code_state.txt
  - Decisions made:
    - Use NOTES.md for append-only session logs
  - Open questions / risks:
    - None
  - Next actions:
    - [ ] Populate code_state.txt after next work session
- Date/Time (2026-01-07 08:40), Session Goal: Add estimation pipeline scaffolding and UI icons
  - What changed:
    - Added schema updates for job status state machine and new tables (job_inputs, ai_outputs, job_files)
    - Added Edge Functions for create-job, run-ai, generate-pdf, and pdf-link
    - Updated job status enums in validation and UI
    - Added PDF link handling in job list/detail and replaced emojis with icons
    - Updated storage notes for estimates bucket
  - Decisions made:
    - Use Edge Functions + pdf-lib for deterministic PDFs
    - Store PDFs under estimates/{job_id}/{timestamp}.pdf
  - Open questions / risks:
    - n8n workflow and function deployment still pending
    - Existing jobs may have legacy statuses not in new enum
  - Next actions:
    - [ ] Wire Submit to n8n listener with job input payload
    - [ ] Confirm PDF bucket privacy strategy (public vs signed)
    - [ ] Run end-to-end test once functions are deployed
- Date/Time (2026-01-07 12:45), Session Goal: Wire n8n submit + resolve legacy job status issue
  - What changed:
    - Added n8n webhook config (hybrid override + env) and Submit webhook POST
    - Added migration to update jobs_status_check and normalize legacy status values
  - Decisions made:
    - Use hybrid webhook URL configuration (override + env)
    - Map legacy `active` status to `ai_pending`
  - Open questions / risks:
    - Migration still needs to be run in Supabase
    - Confirm n8n webhook auth (if required) and environment URL
  - Next actions:
    - [ ] Run `supabase/migrations/20260107_normalize_job_statuses.sql` in Supabase
    - [ ] Set `NEXT_PUBLIC_N8N_WEBHOOK_URL` (or toggle override) and re-test Submit
    - [ ] Verify n8n workflow processes payload end-to-end
- Date/Time (2026-01-07 20:05), Session Goal: Fix delete failures + finalize status migration
  - What changed:
    - Updated migration to add missing delete RLS policy on jobs
    - Added then removed temporary DELETE debug output
  - Decisions made:
    - Enforce delete policy via migration file for consistency
  - Open questions / risks:
    - Ensure migration ran in the correct Supabase environment
  - Next actions:
    - [ ] Verify Submit flow after status constraint fix and policy update
    - [ ] Address templates import error in app/templates/page.tsx
- Date/Time (2026-01-07 20:35), Session Goal: Stabilize auth UX, templates cache, and members display
  - What changed:
    - Added sign-out action in Settings and cleaned members list presentation
    - Fixed templates list import error by using cached templates helper
    - Added profiles table + RLS for member email display
    - Removed Jobs tab from bottom nav
  - Decisions made:
    - Use profiles table in public schema to surface member emails securely
  - Open questions / risks:
    - Profiles migration must be run in Supabase to show emails
  - Next actions:
    - [ ] Run `supabase/migrations/20260107_add_profiles.sql` in Supabase
    - [ ] Verify members list shows email + badges
    - [ ] Re-test Submit → n8n flow end-to-end
- Date/Time (2026-01-08 21:01), Session Goal: Fix photo persistence, branding visibility, labor rates, and form performance
  - What changed:
    - Added job photo persistence via job_files with storage fallback and photo links in job detail
    - Normalized edit form values to avoid save blocking on nulls; disabled submit after submission and redirect to home
    - Added workspace logo rendering in home/jobs headers
    - Added labor rate fields (workspace default + job), updated validation/types, and included rates in n8n payload
    - Improved job create/edit performance by uploading photos asynchronously
    - Added migration for labor_rate columns
  - Decisions made:
    - Use workspace_brand for default labor_rate and job-level override for selection
    - Allow storage listing fallback when job_files table is missing
  - Open questions / risks:
    - Ensure `job_files` table exists in Supabase and RLS policies are applied
    - Run labor_rate migration in Supabase
  - Next actions:
    - [ ] Run `supabase/migrations/20260108_add_labor_rates.sql` in Supabase
    - [ ] Verify new jobs include labor_rate and n8n payload has labor_rate/workspace_labor_rate
    - [ ] Confirm photos persist via job_files once table exists

- Date/Time (2026-01-09 10:30), Session Goal: Enable line items on jobs + save job items as templates
  - What changed:
    - Added line item UI for new/edit job with empty default and template save action via kebab menu
    - Added template save flow from job line items (online + offline queue)
    - Persisted line items via job_items using new line_item type; updated job create/update APIs
    - Added migration and schema update for job_items line_item type; updated types/validation
  - Decisions made:
    - Use job_items with explicit line_item type (migration) for long-term modeling
    - Keep template items stored in templates.template_items_json
  - Open questions / risks:
    - Ensure new migration is applied in Supabase and clients pick up the updated job_items CHECK constraint
  - Next actions:
    - [ ] Run `supabase/migrations/20260109_add_line_item_job_items.sql` in Supabase
    - [ ] Create/edit a job with line items, then save as template and confirm it appears in Templates
    - [ ] Confirm job detail view shows line items and total

- Date/Time (2026-01-09 11:10), Session Goal: Commit changes and attempt push
  - What changed:
    - Committed line item + template flow changes and prior workspace/labor/uploads updates
    - Attempted `git push` but blocked by network restriction
  - Decisions made:
    - None
  - Open questions / risks:
    - Push to GitHub still pending due to network access restrictions
  - Next actions:
    - [ ] Retry `git push` with network access enabled

- Date/Time (2026-01-09 08:52), Session Goal: Fix job_items RLS insert failure on line item edits
  - What changed:
    - Added migration to replace job_items RLS policies using is_member_of(jobs.workspace_id)
    - Updated supabase/schema.sql job_items policy definitions to match
    - Ran migration in Supabase and confirmed line item edit/save works
  - Decisions made:
    - Use is_member_of-based job_items policies for insert/update/delete
  - Open questions / risks:
    - None
  - Next actions:
    - [ ] Re-verify end-to-end n8n flow when ready

- Date/Time (2026-01-09 08:55), Session Goal: Update estimation workflow plan
  - What changed:
    - Noted plan to replace n8n AI workflow with direct OpenAI integration in app backend (Vercel)
  - Decisions made:
    - Use OpenAI API directly from the backend with local env key
  - Open questions / risks:
    - Confirm exact OpenAI model and request/response schema to store in ai_outputs
  - Next actions:
    - [ ] Define OpenAI request payload and storage shape for ai_outputs

- Date/Time (2026-01-09 10:30), Session Goal: Add workspace settings and OpenAI estimate pipeline
  - What changed:
    - Added workspace_settings table migration + schema updates with admin-only updates
    - Added workspace settings API and Settings UI for tax/markup/hourly rate
    - Added OpenAI estimate route with photo analysis + server-side totals rounding
    - Updated job Submit flow to call the new estimate route and removed n8n usage
    - Removed labor rate fields from job create/edit forms
  - Decisions made:
    - Use gpt-4.1-mini for draft estimates with photo analysis
    - Store image analysis in ai_outputs.ai_json and compute totals server-side
    - Round totals to $0.50 increments; apply tax/markup using workspace settings
  - Open questions / risks:
    - Ensure OPENAI_API_KEY is set in Vercel/env.local
  - Next actions:
    - [ ] Run `supabase/migrations/20260109_add_workspace_settings.sql` in Supabase
    - [ ] Configure workspace tax/markup/hourly rate in Settings
    - [ ] Test Submit → OpenAI estimate flow end-to-end

- Date/Time (2026-01-09 10:46), Session Goal: Finalize OpenAI estimation + workspace settings integration
  - What changed:
    - Added workspace_settings table + policies and default row creation on workspace creation
    - Implemented estimate API route using gpt-4.1-mini with image analysis and server-side totals
    - Updated Submit flow to call the estimate route; removed n8n webhook usage
    - Added Settings UI + API for tax/markup/hourly rate; removed job-level labor rate inputs
  - Decisions made:
    - Use workspace_settings (admin-only updates) for tax/markup/hourly rate
    - Round monetary totals to $0.50 increments server-side
  - Open questions / risks:
    - Ensure OpenAI key is configured and estimate route tested in deployed env
  - Next actions:
    - [ ] Run `supabase/migrations/20260109_add_workspace_settings.sql` in Supabase
    - [ ] Set tax/markup/hourly rate defaults in Settings
    - [ ] Test Submit → OpenAI estimate flow with photos

- Date/Time (2026-01-09 15:44), Session Goal: Resolve build/type issues and lint warnings
  - What changed:
    - Fixed Supabase type definitions (jobs status enum, job_files/job_inputs/ai_outputs tables, relationships)
    - Added safe typings to invites/jobs routes and estimate pipeline
    - Cleaned up lint warnings (unused vars, hook deps, no-img-element annotations)
    - Verified `npm run lint` passes with no warnings
  - Decisions made:
    - Prefer local types/unknown over explicit any
  - Open questions / risks:
    - End-to-end OpenAI estimate flow still needs runtime verification
  - Next actions:
    - [ ] Run `npm run build` to confirm production build passes
    - [ ] Test Submit → OpenAI estimate flow with photos

- Date/Time (2026-01-09 16:14), Session Goal: Fix build-time type errors and dynamic route issues
  - What changed:
    - Added runtime guards for cached data hydration across jobs, templates, packages, and members to satisfy strict types
    - Removed unsupported fields from sync/upload queue payloads
    - Marked workspace settings/brand/members API routes as dynamic to avoid static rendering failures with cookies
    - Wrapped login search params usage in Suspense to satisfy Next.js build requirements
    - Tightened IDB store typing with `as const` and excluded Supabase Edge Functions from TS build
    - Added TS annotations for Deno URL imports/env usage in shared edge helper
  - Decisions made:
    - Prefer small runtime guards over regenerating Supabase types for cached JSON
  - Open questions / risks:
    - Production build has not been re-run after these fixes
  - Next actions:
    - [ ] Run `npm run build` to confirm production build passes
    - [ ] Test Submit → OpenAI estimate flow with photos
    - [ ] Retry `git push` with network access enabled

- Date/Time (2026-01-09 17:17), Session Goal: Unblock Vercel middleware error
  - What changed:
    - Added env guard in middleware to avoid crashes when Supabase env vars are missing
  - Decisions made:
    - Fail open (skip auth middleware) if required Supabase env vars are not configured
  - Open questions / risks:
    - Confirm Vercel env vars are set; redeploy to verify middleware no longer crashes
  - Next actions:
    - [ ] Verify Vercel deployment after middleware guard

- Date/Time (2026-01-10 07:17), Session Goal: Fix iOS UX and job create flow reliability
  - What changed:
    - Added theme change event bridge for reliable light/dark/system toggles on iOS
    - Clamped iOS date input width with global CSS and applied to job forms
    - Stabilized job create flow with photo upload await + verify fetch and improved job load error handling
  - Decisions made:
    - Prefer deterministic theme changes via custom event instead of storage-only updates
  - Open questions / risks:
    - Re-test on iPhone to confirm job creation and photo persistence after latest changes
  - Next actions:
    - [ ] Verify iOS job create flow and date input width
    - [ ] Test job photo persistence after save

## Running TODO (prioritized)
1) Integrate OpenAI estimation workflow end-to-end (request, AI output, PDF, job updates)
2) Add job estimate summary + PDF link in list/detail UI
3) Add robust error surfacing for ai_error/pdf_error states
4) Allow users to edit generated estimates
5) Show customer name reference when customer already exists in database
6) Add fields for customer address & contact info
7) Add a config file for AI prompting
8) Use pricing database as a reference before AI creates estimates

## Known Issues
- Issue: Job status enum mismatch across UI/back end in older data
  - Repro: Existing jobs with deprecated status values may fail validation after status enum change
  - Status: Open

## Workflow Notes
- Before `/reset`, ask Codex to summarize into `code_state.txt`.
- After `/reset`, start by reading `ARCHITECTURE.md` + `code_state.txt`.
- Date/Time (2026-01-10 08:05), Session Goal: Fix job creation redirect, photo persistence, and submit errors
  - What changed:
    - Added signed direct-to-Storage job photo uploads and server-side record endpoints to avoid Vercel upload limits
    - Updated job create/edit photo upload flow to use signed uploads and offline queue fallback
    - Hardened job detail and estimate routes against job_files fetch errors
    - Surface estimate submit error messages in the UI
    - Noted build process auto-modifies public/sw.js; revert it before commits
  - Decisions made:
    - Use signed Storage uploads + job_files record endpoint for robust online/offline photo persistence
  - Open questions / risks:
    - Verify production Submit flow returns ai_ready with OPENAI_API_KEY set
  - Next actions:
    - [ ] Re-test job creation redirect and photo persistence on Vercel
    - [ ] Re-test Submit → estimate flow and confirm status update
- Date/Time (2026-01-11 09:05), Session Goal: Stabilize uploads, auth callback, and env diagnostics
  - What changed:
    - Added signed Storage upload flow + record endpoints for job photos (avoids Vercel payload limits)
    - Added env diagnostics response for job detail fetch when Supabase vars are missing
    - Fixed auth callback to persist session cookies
    - Reverted public/sw.js; build touches it and should be reverted before commits
  - Decisions made:
    - Use direct signed uploads to Storage for job photos
  - Open questions / risks:
    - Vercel environment variables still intermittently missing at runtime (see diagnostics)
  - Next actions:
    - [ ] Verify env diagnostics response for /api/jobs/:id after redeploy
    - [ ] Re-test job create + photo persistence + submit flow once env vars persist

- Date/Time (2026-01-13 08:20), Session Goal: Diagnose Vercel env issues, unblock uploads, and add auth bypass for debugging
  - What changed:
    - Added env guards for Supabase service and server clients to surface missing/blank keys
    - Diagnosed Vercel deployment alias caching; confirmed current deploy works for /api/jobs/:id
    - Added temporary middleware flag to bypass auth when DISABLE_AUTH=true
  - Decisions made:
    - Use DISABLE_AUTH env flag to bypass auth during debugging only
  - Open questions / risks:
    - Supabase Storage signed upload failing with "JWS Protected Header is invalid" likely due to invalid service role JWT
    - Email auth disabled blocks access unless bypass flag enabled; must re-enable before production
  - Next actions:
    - [ ] Set DISABLE_AUTH=true in Vercel for debugging access; redeploy
    - [ ] Verify SUPABASE_SERVICE_ROLE_KEY is the raw service role JWT (eyJ...) and redeploy
    - [ ] Re-test photo upload flow (/api/uploads/signed) and job_files insert
- Date/Time (2026-01-16 04:47), Session Goal: Restore auth flow reliability and reduce local build noise
  - What changed:
    - Removed DISABLE_AUTH bypass from middleware
    - Added signed upload debug response (key prefix/length/dot count)
    - Replaced /auth/callback server route with client page and wrapped search params in Suspense
    - Added DISABLE_PWA flag support to suppress PWA generation and set DISABLE_PWA=true in .env.local
    - Added local ignore for public/sw.js via .git/info/exclude; reverted sw.js after builds
  - Decisions made:
    - Use client-side auth callback to let Supabase detect session from magic link
    - Use DISABLE_PWA env flag for local builds to avoid sw.js churn
  - Open questions / risks:
    - Signed upload still failing with JWS Protected Header invalid; confirm Vercel env key/project match
    - Service role key was shared in chat; consider rotating when feasible
  - Next actions:
    - [ ] Redeploy and verify /api/uploads/signed?debug=1 returns expected key shape
    - [ ] Re-test magic link flow end-to-end

- Date/Time (2026-01-21 15:30), Session Goal: Stabilize estimate submit, pricing refs, and PDF generation on Netlify
  - What changed:
    - Added Netlify Next.js plugin and updated README deployment notes to Netlify
    - Added ai_outputs migration and pricing_materials/pricing_labor tables with RLS
    - Added /api/jobs/[id]/ai-output endpoint and submit flow refresh logic
    - Added debug info to estimate route and fixed route param id usage
    - Updated generate-pdf Edge Function to read new ai_json shape and trigger PDF after estimate
    - Added AI estimate display on job detail page
  - Decisions made:
    - Split pricing into separate materials and labor tables with trade enum
    - Use server-side PDF trigger after AI output is written
  - Open questions / risks:
    - Deploy updated generate-pdf Edge Function and confirm PDF generation in production
    - Supabase schema cache reload needed after migrations (PGRST204 seen)
  - Next actions:
    - [ ] Deploy `generate-pdf` Edge Function and set ESTIMATES_BUCKET envs
    - [ ] Re-test Submit → AI → PDF and confirm job status completes
    - [ ] Add UI for editing/viewing AI line items if needed

- Date/Time (2026-01-21 19:38), Session Goal: Validate PDF generation + capture next UI fixes
  - What changed:
    - Confirmed PGRST204 is no longer occurring
    - Generated a PDF using ESTIMATES_BUCKET successfully
  - Decisions made:
    - Show PDF link only when job.status is complete
    - Add separate Re-submit button after submission
  - Open questions / risks:
    - None noted
  - Next actions:
    - [ ] Fix Submit/Re-submit button states and add PDF link on job detail
    - [ ] Add TODOs for estimate editing, customer info, and AI prompt config

- Date/Time (2026-01-22 10:00), Session Goal: Fix PDF link access + align job status updates
  - What changed:
    - Added Submit/Re-submit UI gating and only show PDF link when status is complete
    - Split generate-pdf job status update from pdf_url update for reliability
    - Added auth header to pdf-link calls and CORS handling in pdf-link Edge Function
    - Noted Vercel integration disabled; Netlify remains
  - Decisions made:
    - Keep NEXT_PUBLIC_SUPABASE_URL as base project URL (do not use function URL)
    - Require authenticated JWT for pdf-link; address CORS preflight in function
  - Open questions / risks:
    - pdf-link still returns Invalid JWT; likely stale session or project mismatch
  - Next actions:
    - [ ] Deploy updated pdf-link Edge Function
    - [ ] Clear site data, sign in again, and verify pdf-link request headers
    - [ ] Re-test Open PDF on job detail and home list

- Date/Time (2026-01-23 15:13), Session Goal: Review JWT PDF link fixes and private bucket changes
  - What changed:
    - Switched PDF opening flow to use pdf-link with signed URLs (private bucket), replacing direct public_url usage
    - generate-pdf now stores only storage_path in job_files when using private bucket
    - pdf-link updated to validate JWT via supabaseAdmin.auth.getUser() and to enforce workspace membership before issuing signed URL
    - Added detailed client/server debug logging around PDF link auth and responses
  - Decisions made:
    - Use private estimates bucket with signed URL delivery via pdf-link
    - Validate access via workspace membership, not just job lookup
  - Open questions / risks:
    - Client console logs expose access token previews; remove or gate behind debug flag before production
    - pdf-link still logs verbose auth and request details; confirm whether to keep or reduce
  - Next actions:
    - [ ] Re-test Open PDF end-to-end in Netlify after deploying pdf-link with JWT validation fix
    - [ ] Remove or gate PDF debug logs in app/jobs/[id]/page.tsx and supabase/functions/pdf-link/index.ts

- Date/Time (2026-01-23 19:31), Session Goal: Align pdf-link request method and update logs
  - What changed:
    - Switched job detail PDF open to use supabase.functions.invoke with POST body (job_id)
    - Updated home list PDF open to POST /pdf-link with JSON body and optional Authorization header
    - pdf-link Edge Function now expects POST only and reads job_id from JSON body
    - Added/kept verbose PDF link logging for diagnosis
  - Decisions made:
    - Use POST for pdf-link to align with supabase.functions.invoke usage
  - Open questions / risks:
    - pdf-link no longer validates JWT or workspace membership; private PDF links can be requested without auth
    - Logging is verbose and may expose sensitive metadata
  - Next actions:
    - [ ] Decide whether pdf-link should require JWT + membership checks again
    - [ ] Re-test Open PDF end-to-end after deploy to confirm 401s are resolved

- Date/Time (2026-01-25 07:56), Session Goal: Stabilize UX dialogs, restore photo previews, and add trial links + gating
  - What changed:
    - Replaced native alert/confirm/prompt with Apple-style dialogs and added prompt input support
    - Added wait banners during job creation and AI/PDF generation delays
    - Restored job photo previews by fetching job_files with the service client in /api/jobs/[id]
    - Surfaced real invite errors in Settings and added a friendly duplicate-invite message in /api/invites
    - Added trial support: workspaces subscription_status/trial_ends_at, trial_links table, trial create/redeem API routes, /trial/[token] auto-redeem page
    - Added hasAccess(workspaceId) gating to high-cost routes: /api/jobs (POST), /api/jobs/[id]/estimate, and uploads routes
    - Supabase CLI migration push is blocked by duplicate migration version prefixes; ran 20260124_add_trials.sql manually in Supabase
  - Decisions made:
    - Use Next.js API routes (not Netlify Functions) for trials
    - Per-workspace trials with only one active trial at a time; 30-day trial length
    - Gate API first (estimate, job create, uploads) and add UI gating later
    - Auto-redeem trial links on /trial/[token]
  - Open questions / risks:
    - Production requires TRIAL_TOKEN_PEPPER (and consistent INVITE_TOKEN_PEPPER); redeploy needed after env updates
    - Migration history remains inconsistent due to duplicate version prefixes; consider renaming migrations + repair
    - pdf-link function still lacks JWT/membership enforcement and contains verbose logging
    - Service client debug logging remains in lib/supabase/service.ts
  - Next actions:
    - [ ] Set TRIAL_TOKEN_PEPPER and INVITE_TOKEN_PEPPER in Netlify and redeploy
    - [ ] Generate a trial link via POST /api/trials/create and redeem it for the target workspace
    - [ ] Add UI gating/banners for inactive subscriptions (e.g., hide/disable Submit/New Job)
    - [ ] Decide whether to restore pdf-link JWT + workspace membership enforcement and remove debug logs
- Date/Time (2026-01-26 05:56), Session Goal: Add workspace-scoped prompt templates + default prompt loading
  - What changed:
    - Added migration to create prompt_templates and ai_reference_configs, add workspaces.trade + default_ai_reference_config_id, seed prompts, and add backfill function
    - Updated onboarding to select trade and workspace creation to seed default ai_reference_configs from templates
    - Added getWorkspacePrompt helper and updated estimate route to load workspace prompt with fallback chain and include Scope Summary/Job Summary inputs
    - Enforced server-side pricing_materials override for material costs and stored prompt metadata in ai_outputs
    - Updated schema.sql and Supabase types; added verification script and README notes
    - Fixed legacy ai_reference_configs schema mismatch by dropping config_json/is_active in migration
  - Decisions made:
    - Use per-workspace ai_reference_configs derived from prompt_templates, with workspaces.default_ai_reference_config_id as primary lookup
    - Keep pricing override server-side and record prompt metadata for debugging
  - Open questions / risks:
    - Migration and backfill need to run in Supabase; existing ai_reference_configs rows must be compatible
    - Existing lint warnings still present (pre-existing)
  - Next actions:
    - [ ] Apply supabase/migrations/20260125_add_workspace_prompt_schemes.sql in Supabase
    - [ ] Run backfill: select public.backfill_workspace_ai_reference_configs();
    - [ ] Test Submit → estimate and confirm ai_outputs.metadata includes prompt_id/source/trade
- Date/Time (2026-01-26 15:20), Session Goal: Stabilize estimates, PDF delivery, and pricing/catalog matching
  - What changed:
    - Switched estimate numbers to date-based format and added UI fallback for older estimates
    - Added pricing tables to Supabase types and tightened prompt trade typing
    - Fixed generate-pdf to mark jobs complete when PDF already exists
    - Improved PDF layout (workspace header, wrapping, spacing) and added “Powered by RelayKit”
    - Adjusted PDF open flow for iOS (same-tab) and removed desktop blank-tab pre-open
    - Restored job description display in draft-only view
    - Improved pricing matching (normalization + fuzzy token matching)
    - Added catalog retrieval (top 60) from pricing_materials into AI prompt
    - Enhanced submit/create banners with animated, higher-contrast status UI
  - Decisions made:
    - Use retrieval (top 60) from pricing_materials to steer AI material selection
    - Keep iOS PDF opening in same tab for reliability
    - Show job description only before initial submission
  - Open questions / risks:
    - Ensure pricing_materials trade matches workspace trade to avoid empty catalog
    - Re-run estimates + regenerate PDFs to see layout/price updates
    - Edge Functions must be deployed for PDF layout/status changes to take effect
  - Next actions:
    - [ ] Deploy updated generate-pdf Edge Function and re-generate a PDF (force true or re-submit)
    - [ ] Re-run estimate to apply catalog retrieval + pricing match updates
    - [ ] Verify material pricing matches expected catalog items
- Date/Time (2026-01-26 20:21), Session Goal: Improve UX feedback, pricing selection, and PDF lifecycle
  - What changed:
    - Centered submit/create loading toast with modal styling; removed progress bar
    - Restored draft-only description display in job detail
    - Improved material price matching (normalization + fuzzy token overlap)
    - Added pricing catalog retrieval (top 60) into AI prompt
    - Adjusted PDF open flow (iOS same-tab only; removed desktop blank tab)
    - Updated generate-pdf to keep only the latest PDF and clean old files
  - Decisions made:
    - Use retrieval-based catalog injection (top 60) for AI material selection
    - Keep only the most recent PDF per job; delete older PDFs on regeneration
  - Open questions / risks:
    - Ensure workspace trade matches pricing_materials trade to avoid empty catalog
    - Edge Functions must be deployed for PDF layout/lifecycle changes
  - Next actions:
    - [ ] Deploy updated generate-pdf Edge Function
    - [ ] Re-run estimate to apply catalog retrieval and pricing match changes
    - [ ] Verify material pricing aligns with catalog after re-submit
- Date/Time (2026-01-30 06:34), Session Goal: Revert to stable estimate behavior and selectively reapply features
  - What changed:
    - Created backup branch `backup_pre_revert_20260129_1225` to preserve pre-revert state
    - Reverted codebase to commit 19530fb via revert commit (history preserved)
    - Re-applied customer + workspace pricing override logic (cba830f) but removed pricing import API endpoint
    - Re-applied lint cleanup (9a56a81)
    - Re-applied alias cleanup (split commas/semicolons) and snake_case normalization for pricing matching
    - Removed MISSING PRICE prompt instruction; replaced with human-readable wording guidance
    - Added `project_notes/` to .gitignore; removed comparison file
  - Decisions made:
    - Keep current state recoverable via backup branch instead of hard reset
    - Exclude pricing import API endpoint while retaining customer/override schema and logic
  - Open questions / risks:
    - Large catalog (20k+ rows) may still reduce matching accuracy
    - Prompt templates still need updates to suppress SKU/part-number outputs
    - Optional commit 0ada82c (GC cross-trade defaults) may be reintroduced if needed
  - Next actions:
    - [ ] Update prompt_templates (plumbing + general_contractor) to enforce human-readable material names
    - [ ] Re-run estimate to validate pricing accuracy on curated data
    - [ ] Consider narrowing catalog or adding stricter matching thresholds if still off
